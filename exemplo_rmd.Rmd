---
title: "Projeto Final"
author: "Anderson Caio Emerson Tiago Vinicius"
date: '2023-06-17'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
```

# Projeto Integrado – final

A QuantumFinance está acompanhando um crescimento de inadimplência entre seus clientes e solicita a consultoria para desenvolver uma análise de inadimplência.

Os resultados apresentados pela consultoria mostram que o modelo de credit scoring implementado utilizou 70 variáveis e apresentou uma acurácia de 26% (R2 ajustado = 0.2593609). Consequentemente, a QuantumFinance está oferecendo crédito para mau pagador e deixando de oferecer para o bom pagador.

Para que a QuantumFinance tome decisões mais precisas sobre concessões de crédito, ela precisa aprimorar seu modelo de concessão de crédito.

Desafio: Melhorar a acurácia do modelo preditivo mediante uso do valor target disponível na base de dados train.csv.

## 3ª etapa: Conhecer os dados

A base de dados contém uma coluna chamada id que identifica exclusivamente cada linha, várias colunas identificadas por strings hexadecimais e um destino de coluna que gostaríamos que você previsse. As colunas que contêm hashes SHA-256 para seus valores representam variáveis categóricas, enquanto o restante das variáveis é numérica. O arquivo test.csv tem os mesmos nomes de coluna e tipos de dados que train.csv, mas está faltando a coluna da variável resposta. Não há valores ausentes ou problemas de corrupção de dados em nenhum desses arquivos. Não se preocupe com os significados das variáveis ou dos metadados - este é um conjunto de dados artificial. 

| Variável   | Tipo da variável (natureza) |
|:----------:|:---------------------------:|
| 016399044a | Quantitativa discreta       |
| 023c68873b | Qualitativa nominal         |
| 0342faceb5 | Quantitativa discreta       |
| 04e7268385 | Quantitativa discreta       |
| 06888ceac9 | Qualitativa nominal         |
| 072b7e8f27 | Quantitativa contínua       |
| 087235d61e | Quantitativa discreta       |
| 0b846350ef | Quantitativa contínua       |
| 0e2ab0831c | Quantitativa contínua       |
| 12eda2d982 | Quantitativa contínua       |
| 136c1727c3 | Quantitativa contínua       |
| 173b6590ae | Quantitativa contínua       |
| 174825d438 | Quantitativa discreta       |
| 1f222e3669 | Quantitativa contínua       |
| 1f3058af83 | Quantitativa discreta       |
| 1fa099bb01 | Quantitativa discreta       |
| 20f1afc5c7 | Quantitativa contínua       |
| 253eb5ef11 | Quantitativa contínua       |
| 25bbf0e7e7 | Quantitativa discreta       |
| 2719b72c0d | Quantitativa contínua       |
| 298ed82b22 | Quantitativa contínua       |
| 29bbd86997 | Quantitativa contínua       |
| 2a457d15d9 | Quantitativa discreta       |
| 2bc6ab42f7 | Quantitativa contínua       |
| 2d7fe4693a | Quantitativa contínua       |
| 2e874bc151 | Quantitativa contínua       |
| 361f93f4d1 | Qualitativa nominal         |
| 384bec5dd1 | Qualitativa nominal         |
| 3df2300fa2 | Quantitativa contínua       |
| 3e200bf766 | Quantitativa discreta       |
| 3eb53ae932 | Quantitativa contínua       |
| 435dec85e2 | Quantitativa contínua       |
| 4468394575 | Quantitativa contínua       |
| 49756d8e0f | Quantitativa contínua       |
| 4fc17427c8 | Quantitativa contínua       |
| 55907cc1de | Quantitativa contínua       |
| 55cf3f7627 | Quantitativa contínua       |
| 56371466d7 | Quantitativa discreta       |
| 5b862c0a8f | Quantitativa discreta       |
| 5f360995ef | Quantitativa discreta       |
| 60ec1426ce | Quantitativa contínua       |
| 63bcf89b1d | Quantitativa contínua       |
| 6516422788 | Quantitativa contínua       |
| 65aed7dc1f | Quantitativa discreta       |
| 6db53d265a | Quantitativa discreta       |
| 7734c0c22f | Quantitativa contínua       |
| 7743f273c2 | Quantitativa contínua       |
| 779d13189e | Quantitativa contínua       |
| 77b3b41efa | Quantitativa contínua       |
| 7841b6a5b1 | Quantitativa contínua       |
| 789b5244a9 | Quantitativa contínua       |
| 7925993f42 | Quantitativa contínua       |
| 7cb7913148 | Qualitativa ordinal         |
| 7fe6cb4c98 | Quantitativa contínua       |
| 8311343404 | Quantitativa contínua       |
| 87b982928b | Quantitativa contínua       |
| 8a21502326 | Quantitativa contínua       |
| 8c2e088a3d | Quantitativa discreta       |
| 8d0606b150 | Qualitativa nominal         |
| 8de0382f02 | Quantitativa discreta       |
| 8f5f7c556a | Quantitativa discreta       |
| 91145d159d | Qualitativa nominal         |
| 96c30c7eef | Quantitativa contínua       |
| 96e6f0be58 | Quantitativa contínua       |
| 98475257f7 | Quantitativa contínua       |
| 99d44111c9 | Quantitativa discreta       |
| 9a575e82a4 | Qualitativa nominal         |
| 9b6e0b36c2 | Quantitativa contínua       |
| a14fd026ce | Quantitativa discreta       |
| a24802caa5 | Quantitativa contínua       |
| aa69c802b6 | Quantitativa contínua       |
| abca7a848f | Quantitativa discreta       |
| ac826f0013 | Quantitativa contínua       |
| ae08d2297e | Quantitativa discreta       |
| aee1e4fc85 | Quantitativa contínua       |
| b4112a94a6 | Quantitativa contínua       |
| b709f75447 | Quantitativa contínua       |
| b835dfe10f | Qualitativa nominal         |
| b9a487ac3c | Quantitativa contínua       |
| ba54a2a637 | Quantitativa contínua       |
| bdf934caa7 | Quantitativa contínua       |
| beb6e17af1 | Quantitativa discreta       |
| c0c3df65b1 | Quantitativa discreta       |
| c1b8ce2354 | Quantitativa discreta       |
| c58f611921 | Quantitativa contínua       |
| d035af6ffa | Quantitativa discreta       |
| d2c775fa99 | Quantitativa discreta       |
| d4d6566f9c | Quantitativa discreta       |
| dcfcbc2ea1 | Quantitativa discreta       |
| e0a0772df0 | Quantitativa contínua       |
| e16e640635 | Qualitativa nominal         |
| e5efa4d39a | Quantitativa contínua       |
| e7ee22effb | Quantitativa discreta       |
| e86a2190c1 | Quantitativa discreta       |
| ea0f4a32e3 | Quantitativa contínua       |
| ed7e658a27 | Quantitativa discreta       |
| ee2ac696ff | Quantitativa contínua       |
| f013b60e50 | Quantitativa contínua       |
| f0a0febd35 | Quantitativa contínua       |
| f1f0984934 | Qualitativa nominal         |
| f66b98dd69 | Quantitativa contínua       |
| fbf66c8021 | Quantitativa contínua       |
| fdf8628ca7 | Quantitativa discreta       |
| fe0318e273 | Quantitativa contínua       |
| fe8cdd80ba | Quantitativa contínua       |
| ffd1cdcfc1 | Quantitativa contínua       |
| id         | Id                          |
| target     | Quantitativa contínua       |

## 4ª etapa: Preencher o quadro conceitual estatístico.  

| Variável   | Tipo da variável (natureza) |
|----------|---------------------------|
| 1.	Plano Básico de Análise | 1.	Importação dos dados. |
|  | 2.	Limpeza e pré-processamento dos dados. |
|  | 3.	Análise exploratória dos dados. |
|  | 4.	Criação de gráficos e visualizações. |
|  | 5.	Teste de hipóteses ou comparação de grupos. |
|  | 6.	Ajuste de modelos estatísticos. |
|  | 7.	Avaliação da qualidade do modelo. |
|  | 8.	Interpretação dos resultados. |
|  | 9.	Comunicação dos resultados de forma clara e concisa. |

```{r resultados_notacao}
# nao mostrar os resultados na notacao cientifica
options(scipen = 999)
```

## 5ª etapa: Faça a análise descritiva das variáveis. Apresente os gráficos e as medidas resumos. 

### Import de pacotes utilizados

```{r pacotes, message=FALSE}
library(tidyverse)
library(ggplot2)
library(summarytools)
library(gmodels)
library(dplyr)
library(fastDummies)
```

### Leitura dos dados train.csv

```{r leitura_dados, message=FALSE}
library(readr)
df <- read_csv("./data/train.csv")
```

Os dados apresentam nomes de colunas dificeis de serem identificadas, então o primeiro passo foi converter todas as colunas das variáveis preditoras para x1,x2,x3,...,xn e criar um dicionario pra identificalas.

```{r dicionario_variaveis}
# Nomes das colunas que você quer renomear
colunas_para_renomear <- setdiff(names(df), c("id", "target"))

# Número de colunas para renomear
num_colunas <- length(colunas_para_renomear)

# Inicializando o dicionário
dicionario <- list()

# Renomear as colunas para x1, x2, x3, ... e criar o dicionario
for (i in 1:num_colunas) {
    colname <- colunas_para_renomear[i]
    new_colname <- paste("x", i, sep="")
    
    # Adicionando ao dicionário
    dicionario[[new_colname]] <- colname
    
    print(paste(colname, "->", new_colname))
    
    # Renomeando a coluna
    names(df)[names(df) == colname] <- new_colname
}
```
Durante nossa analise identificamos todas as variaveis qualitativas e as transformamos em variaveis do tipo factor.

```{r variaveis_qualitativas}
df$x2 <- factor(df$x2)
df$x5 <- factor(df$x5)
df$x27 <- factor(df$x27)
df$x28 <- factor(df$x28)
df$x53 <- factor(df$x53, ordered=TRUE)
df$x59 <- factor(df$x59)
df$x62 <- factor(df$x62)
df$x67 <- factor(df$x67)
df$x78 <- factor(df$x78)
df$x91 <- factor(df$x91)
df$x100 <- factor(df$x100)

```

Com as variaveis devidamente transformadas fazemos a analise descritiva(Conhecer as variaveis):

```{r analise_descritiva}
# medidas resumo
summary(df)
```

### Grafico univariado da target

```{r Grafico_univariado_da_target}
# grafico de uma variavel
qplot(x=df$target)
```
#### Separamos as variaveis quantitativas, qualitativas e a variavel target para fazermos manipulações de maneira mais facil

```{r separacao_variaveis}
dadosQuali <- df %>%
  select(x2,x5,x27,x28,x53,x59,x62,x67,x78,x91,x100)

dadosQuant <- df %>%
  select(-c(id,target,x2,x5,x27,x28,x53,x59,x62,x67,x78,x91,x100))

target <- df$target

```

### Análise bivariada das variáveis qualitativas

```{r analise_bivariada_variaveis_qualitativas}

# Gráficos de barras para x2 e x5
barplot(table(df$x2), main="Gráfico de barras de x2", xlab="x2")
barplot(table(df$x5), main="Gráfico de barras de x5", xlab="x5")
barplot(table(df$x27), main="Gráfico de barras de x27", xlab="x27")
barplot(table(df$x28), main="Gráfico de barras de x28", xlab="x28")
barplot(table(df$x53), main="Gráfico de barras de x53", xlab="x53")
barplot(table(df$x59), main="Gráfico de barras de x59", xlab="x59")
barplot(table(df$x62), main="Gráfico de barras de x62", xlab="x62")
barplot(table(df$x67), main="Gráfico de barras de x67", xlab="x67")
barplot(table(df$x78), main="Gráfico de barras de x78", xlab="x78")
barplot(table(df$x91), main="Gráfico de barras de x91", xlab="x91")
barplot(table(df$x100), main="Gráfico de barras de x100", xlab="x100")

```

# 6ª etapa: Faça a análise bivariada das variáveis qualitativas. 

Analise da variavel target vs x53, x5, x28 e x67

Primeiro passo: transformar a variavel quantitativa (target) em uma qualitativa (faixa de target)

Criterio: fórmula de Sturges

```{r calculo_faixa_sturges}

# Calcular o número de bins usando a fórmula de Sturges
n <- length(df$target)
k <- round(1 + 3.322 * log10(n))

```

#### Para análise bivariada das variáveis qualitativas criamos as faixas de valores para variavel target.

```{r faixa_sturges}

# Criar a variável faixa de target
df1 <- df

# Usando cut para criar as faixas e labels apropriadas
df1$fxtarget_cat <- cut(df$target, breaks = k, include.lowest = TRUE, dig.lab = 10)

# Converter para um fator ordenado
df1$fxtarget_cat <- factor(df1$fxtarget_cat, ordered = TRUE)

# Mostrando as frequências das faixas
freq(df1$fxtarget_cat)

```
### a)	Tabela de frequência bivariada
### b)	Teste Qui-quadrado.

Como resultado do CrossTable temos uma	tabela de frequência bivariada que compara duas variáveis categóricas e tambem ja nos apresenta o teste Qui-quadrado como output.

Statistics for All Table Factors: Nesta seção, temos o resultado do teste qui-quadrado de Pearson que testa a independência entre as duas variáveis categóricas.

* Chi^2: O valor da estatística qui-quadrado.
* d.f.: Os graus de liberdade para o teste.
* p: O valor-p associado ao teste qui-quadrado. quando este valor é extremamente próximo de 0, sugere que podemos rejeitar a hipótese nula de que as duas variáveis são independentes.

CrossTable (x53 e target)

```{r frequencia_bivariada_Qui_quadrado_x53}
df1$quali_x53 <- factor(df1$x53)

CrossTable(df1$fxtarget_cat,df1$quali_x53, prop.r = FALSE, prop.c = FALSE, prop.t = FALSE,
           prop.chisq = FALSE,chisq = TRUE)

```
CrossTable (x5 e target)

```{r frequencia_bivariada_Qui_quadrado_x5}
df1$quali_x5 <- factor(df1$x5)

CrossTable(df1$fxtarget_cat,df1$quali_x5, prop.r = FALSE, prop.c = FALSE, prop.t = FALSE,
           prop.chisq = FALSE,chisq = TRUE)

```
CrossTable (x28 e target)

```{r frequencia_bivariada_Qui_quadrado_x28}
df1$quali_x28 <- factor(df1$x28)

CrossTable(df1$fxtarget_cat,df1$quali_x28, prop.r = FALSE, prop.c = FALSE, prop.t = FALSE,
           prop.chisq = FALSE,chisq = TRUE)

```
CrossTable (x67 e target)

```{r frequencia_bivariada_Qui_quadrado_x67}
df1$quali_x67 <- factor(df1$x67)

CrossTable(df1$fxtarget_cat,df1$quali_x67, prop.r = FALSE, prop.c = FALSE, prop.t = FALSE,
           prop.chisq = FALSE,chisq = TRUE)

```
## c)	Gráfico 100% empilhado

```{r Grafico_100_empilhado_x53}
ggplot(df1, aes(fill = fxtarget_cat, x = quali_x53)) +
  geom_bar(position = "fill") +
  geom_text(
    aes(label = paste0(round(100 * ..count../sum(..count..), 2), "%"),
        y = ..count..),
    position = position_fill(vjust = 0.5),
    stat = "count",
    size = 3,
    color = "white"  # Definir a cor do label como branca
  ) +
  labs(y = "Porcentagem", x = "Quali x53", title = "Gráfico 100% Empilhado de target_cat por x53") +
  scale_y_continuous(labels = scales::percent_format(scale = 1))
```

```{r Grafico_100_empilhado_x5}
ggplot(df1, aes(fill = fxtarget_cat, x = quali_x5)) +
  geom_bar(position = "fill") +
  geom_text(
    aes(label = paste0(round(100 * ..count../sum(..count..), 2), "%"),
        y = ..count..),
    position = position_fill(vjust = 0.5),
    stat = "count",
    size = 3,
    color = "white"  # Definir a cor do label como branca
  ) +
  labs(y = "Porcentagem", x = "Quali x5", title = "Gráfico 100% Empilhado de target_cat por x5") +
  scale_y_continuous(labels = scales::percent_format(scale = 1))
```

## 7ª etapa: Faça a análise bivariada das variáveis quantitativas. 

### e)	Análise de correlação de Pearson.
### f)	Matriz de correlação de Pearson.

Selecionando as top 10 variaveis preditoras para fazermos a análise bivariada das variáveis quantitativas utilizando a correlação de pearson

#### 1º passo - Aplicar correlação de pearson nas variaveis quantitativas

```{r correlacao_pearson}
df_quant_corr <- cbind(dadosQuant,target)

# Calculando a matriz de correlação de pearson
correlacao <- cor(df_quant_corr)
head(correlacao)
```
